<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='tupai-Application'>/**
</span> * @class tupai.Application
 * @author &lt;a href='bocelli.hu@gmail.com'&gt;bocelli.hu&lt;/a&gt;
 * @docauthor &lt;a href='bocelli.hu@gmail.com'&gt;bocelli.hu&lt;/a&gt;
 * @since tupai.js 0.1
 * This is application.
 * You can get the static instance by use ThisApplication.instance
 */
Package('tupai')
.use('tupai.events.Events')
.use('tupai.model.CacheManager')
.use('tupai.model.ApiManager')
.use('tupai.util.CommonUtil')
.use('tupai.Window')
.define('Application', function(cp) { return Package.Class.extend({
    _window  : undefined,
    _delegate: undefined,
    _events  : undefined,
    DEFAULT_WIN_ID: 'default',

<span id='tupai-Application-method-initialize'>    /**
</span>     * initialize
     * @param config
     * @param delegate
     *
     */
    initialize : function(config, delegate) {

        this._setupWindows(config, delegate);
        this._delegate = delegate;
        if(config) {
            this._attributes = config.attributes;
            this.addApiManagers(config.apiManagers);
            this.addApiManager(config.apiManager);
            this.setupCacheManager(config.cacheManager);
        }

        this._events = new cp.Events();
        cp.Application.instance = this;

        this._delegate &amp;&amp;
        this._delegate.didApplicationLoad &amp;&amp;
        this._delegate.didApplicationLoad();
    },
    _setupWindows: function(config, delegate) {

        this._windows = {};

        var getConfig;
        if(config &amp;&amp; config.windows) {
            getConfig = function(id) {
                return config.windows[id];
            };
        } else {
            getConfig = function(id) {
                var ret = config &amp;&amp; config.window;
                return ret || {};
            };
        }

        var createWindow;
        if(delegate) {
            createWindow = function(id, element) {
                var config = getConfig(id);
                config.winConfig = {element: element, id: id};
                return delegate.createWindow(config, id);
            };
        } else {
            createWindow = function(id, element) {
                var config = getConfig(id);
                config.winConfig = {element: element, id: id};
                return new cp.Window(config);
            };
        }

        var elements = document.querySelectorAll('*[data-ch-window]');
        if(!elements || elements.length &lt; 1) {
            var element =  document.getElementsByTagName('body')[0];
            this._windows[this.DEFAULT_WIN_ID] = createWindow(this.DEFAULT_WIN_ID, element);
        } else {
            for(var i=0, n=elements.length; i&lt;n; i++) {
                var element = elements[i];
                var id = cp.CommonUtil.getDataSet(element, 'chWindow') || this.DEFAULT_WIN_ID;
                this._windows[id] = createWindow(id, element);
            }
        }
    },

<span id='tupai-Application-method-setupCacheManager'>    /**
</span>     * setup application setup CacheManager
     * @param config CacheManager config
     */
    setupCacheManager: function(config) {
        if(!config) return;
        if(this._cacheManager) throw new Error('CacheManager has already setup.');
        this._cacheManager = new cp.CacheManager(config);
    },

<span id='tupai-Application-method-addApiManager'>    /**
</span>     * add an ApiManager by name
     * @param config ApiManager config
     * @param [name] ApiManager name
     */
    addApiManager: function(config, name) {
        if(!config) return;
        if(!this._apiManagers) this._apiManagers = {};

        name = name || 'default';
        this._apiManagers[name] = new cp.ApiManager(config);
    },

<span id='tupai-Application-method-addApiManagers'>    /**
</span>     * add some ApiManagers
     * @param config ApiManager's configs
     */
    addApiManagers: function(config) {
        if(!config) return;
        for(var name in config) {
            this.addApiManager(config[name], name);
        }
    },

<span id='tupai-Application-method-getCacheManager'>    /**
</span>     * get CacheManager instance
     */
    getCacheManager: function() {
        return this._cacheManager;
    },

<span id='tupai-Application-method-getCache'>    /**
</span>     * get Cache by name
     */
    getCache: function(name) {
        return this._cacheManager.getCache(name);
    },

<span id='tupai-Application-method-getApiManager'>    /**
</span>     * get an ApiManager by name
     * @param [name] ApiManager name
     */
    getApiManager: function(name) {
        name = name || 'default';
        return this._apiManagers[name];
    },

<span id='tupai-Application-method-setAttribute'>    /**
</span>     * set a custom attribute
     * @param name attribute name
     * @param value attribute value
     */
    setAttribute: function(name, value) {
        if(!this._attributes) this._attributes = {};
        var old = this._attributes[name];
        this._attributes[name] = value;
        return old;
    },

<span id='tupai-Application-method-getAttribute'>    /**
</span>     * get the custom attribute by name
     * @param name attribute name
     */
    getAttribute: function(name) {
        return this._attributes &amp;&amp; this._attributes[name];
    },

<span id='tupai-Application-method-fire'>    /**
</span>     * fire application level event
     * @param type event type
     * @param parameter event parameter
     */
    fire: function(type, parameter) {
        this._events.fire(type, parameter);
    },

<span id='tupai-Application-method-addEventListener'>    /**
</span>     * add event listener
     * @param {String} type event type
     * @param {Object} listener event listener
     * @param {Boolean} [first] add listener to the top of event pool
     */
    addEventListener: function(type, listener, first) {
        this._events.addEventListener(type, listener, first);
    },

<span id='tupai-Application-method-removeEventListener'>    /**
</span>     * remove event listener
     * @param type event type
     * @param listener which listener to remove
     */
    removeEventListener: function(type, listener) {
        this._events.removeEventListener(type, listener);
    },

<span id='tupai-Application-method-close'>    /**
</span>     * close this application.
     */
    close: function() {
        this._delegate &amp;&amp;
        this._delegate.didApplicationUnload &amp;&amp;
        this._delegate.didApplicationUnload();
    },

<span id='tupai-Application-method-getWindow'>    /**
</span>     * get window by id
     * @param {String} [id] optional
     */
    getWindow: function(id) {
        return this._windows[id || this.DEFAULT_WIN_ID];
    },

<span id='tupai-Application-method-show'>    /**
</span>     * show root url
     * @param {String} url root controller url
     * @param {Object} options root controller options
     * @param {String} [id] witch window to show
     */
    show: function(url, options, id) {
        var win = this._windows[id || this.DEFAULT_WIN_ID];
        win &amp;&amp; win.showRoot(url, options);
    }
});});

</pre>
</body>
</html>
